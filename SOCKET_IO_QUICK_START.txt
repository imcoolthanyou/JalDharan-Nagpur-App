================================================================================
QUICK START: SOCKET.IO INTEGRATION FOR JAL DHARAN
================================================================================

Follow these steps to get Socket.IO real-time updates working:

================================================================================
STEP 1: UPDATE API CONFIG
================================================================================

File: lib/core/config/api_config.dart

Change the baseUrl to match your backend server IP:

âœ… CURRENT (Windows Machine):
static const String baseUrl = 'http://192.168.1.10:8000';

Change to your actual backend IP:
- Windows Server: http://<YOUR_WINDOWS_IP>:8000
- Check IP: Open CMD â†’ ipconfig (look for IPv4 Address)

Example if backend is at 192.168.1.100:
static const String baseUrl = 'http://192.168.1.100:8000';

For Android Emulator (if backend on same PC):
static const String baseUrl = 'http://10.0.2.2:8000';

For iOS Simulator (if backend on same Mac):
static const String baseUrl = 'http://localhost:8000';

================================================================================
STEP 2: VERIFY BACKEND SOCKET.IO SERVER
================================================================================

Your Python/Node.js backend must:

1. âœ… Have Socket.IO server running on port 8000
2. âœ… Emit 'sensor_update' event when ESP32 sends data
3. âœ… Include all required JSON fields in the event

Test with curl (or use Socket.IO client online):
- Connect to: ws://<YOUR_BACKEND_IP>:8000
- Listen for: 'sensor_update' event
- Should receive JSON every time ESP32 updates

================================================================================
STEP 3: RUN THE APP
================================================================================

Terminal commands:

1. Get dependencies:
   flutter pub get

2. Run the app:
   flutter run

3. Watch logs for Socket.IO messages:
   flutter logs

Expected console output:
ğŸ”Œ Initializing Socket.IO connection to http://192.168.1.10:8000
âœ… Socket Connected to backend
ğŸ“¡ New Sensor Data Received: {...}
ğŸ”„ HomeScreen received Socket update: {...}
âœ… HomeScreen UI updated with new socket data

================================================================================
STEP 4: TEST REAL-TIME UPDATES
================================================================================

In the app:
1. Go to Home Screen
2. Watch the water depth, flow rate, pH, TDS values
3. Change sensor values on your hardware/backend
4. Values should update automatically within 1 second
5. No need to refresh or switch screens

Check Logs:
- Open Terminal/Console in Android Studio
- Filter for 'Socket' or 'HomeScreen'
- You should see rapid updates as sensors change

================================================================================
STEP 5: FALLBACK TO HTTP POLLING
================================================================================

If Socket.IO connection fails:
- App automatically falls back to HTTP polling
- Updates every 10 seconds from /mobile/dashboard endpoint
- No red error messages shown to user
- Errors logged to console only

To test fallback:
1. Stop backend Socket.IO server
2. App will show "Connecting..." status briefly
3. Falls back to HTTP polling
4. Data continues updating (slower)

================================================================================
TROUBLESHOOTING
================================================================================

ISSUE: "Connection refused" error in logs
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Fix:
1. Check backend server is running: python app.py (or your start command)
2. Verify backend IP in ApiConfig matches (check ipconfig)
3. Check firewall allows port 8000
4. If on Android emulator, use 10.0.2.2 instead of localhost

ISSUE: No sensor data updates
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Fix:
1. Check backend is emitting 'sensor_update' events
2. Verify Socket.IO connected (look for "âœ… Socket Connected")
3. Check sensor data in /mobile/dashboard endpoint manually
4. If endpoint works but socket doesn't, backend Socket.IO might not be configured

ISSUE: Data updates very slow
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Fix:
1. Check if Socket.IO connected or using HTTP fallback
2. Look in logs: "Socket Connected" = fast, "API Error" = using HTTP
3. Increase backend emission frequency if possible
4. Check network latency: ping <backend_ip>

ISSUE: App crashes on startup
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Fix:
1. Run: flutter pub get
2. Run: flutter clean
3. Run: flutter pub get (again)
4. Run: flutter run

ISSUE: Socket connects but no data received
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Fix:
1. Check backend is actually sending 'sensor_update' events
2. Verify JSON payload format matches expectations
3. Check GroundwaterData.fromJson() can parse the JSON
4. Log the incoming JSON on backend to debug

================================================================================
IMPORTANT: BEFORE PUSHING TO GIT
================================================================================

DO NOT commit with:
âŒ Real API credentials/tokens in code
âŒ Debug/test IP addresses as defaults
âŒ Sensitive configuration in config files

DO commit with:
âœ… Example/placeholder IP addresses in comments
âœ… Instructions for developers to update config
âœ… Socket.IO integration guide (this file!)
âœ… Clean code without debug logs

================================================================================
ARCHITECTURE SUMMARY
================================================================================

How data flows:

ESP32 Sensor
     â†“ (sends data via HTTP)
Backend API (/sensor/update)
     â†“
Socket.IO Server (broadcasts to all connected clients)
     â†“
SocketService (lib/core/services/socket_service.dart)
     â”œâ”€â”€ Listens to 'sensor_update' event
     â”œâ”€â”€ Parses JSON â†’ GroundwaterData
     â”œâ”€â”€ Calls registered listeners
     â””â”€â”€ Updates ChangeNotifier (Provider)
     â†“
HomeScreen / AnalyticsScreen
     â”œâ”€â”€ Registered as listener
     â”œâ”€â”€ Receives callback with new data
     â”œâ”€â”€ Updates UI via setState()
     â””â”€â”€ User sees live updates

================================================================================
KEY FILES MODIFIED/CREATED
================================================================================

NEW FILES:
âœ… lib/core/services/socket_service.dart
   - Main Socket.IO service class
   - Handles connection lifecycle
   - Provides callback system

âœ… lib/core/widgets/socket_widgets.dart
   - SocketStatusIndicator (shows connection status)
   - SocketReconnectButton (manual reconnect)
   - LatestDataDisplay (debug widget)

âœ… SOCKET_IO_INTEGRATION.txt (this directory)
   - Comprehensive technical documentation

âœ… SOCKET_IO_QUICK_START.txt (this file)
   - Developer quick start guide

MODIFIED FILES:
âœ… pubspec.yaml
   - Added socket_io_client: ^2.0.0
   - Added provider: ^6.0.0

âœ… lib/main.dart
   - Added SocketService Provider setup
   - Initialize Socket when user logs in

âœ… lib/presentation/screens/home/home_screen.dart
   - Integrated Socket listener
   - Real-time data updates via callback
   - Fallback HTTP polling maintained

âœ… lib/presentation/screens/analytics/analytics_screen.dart
   - Integrated Socket listener
   - Real-time prediction updates
   - Automatic chart refresh

âœ… lib/core/config/api_config.dart
   - Added comprehensive documentation
   - Socket.IO configuration notes

================================================================================
NEXT STEPS FOR BACKEND DEVELOPERS
================================================================================

Your Python/Node.js backend needs to:

1. Install Socket.IO library for your framework
2. Create Socket.IO server listening on port 8000 (same as HTTP API)
3. When ESP32 sends sensor data, emit 'sensor_update' event
4. Connected Flutter clients will receive data in real-time

Example (Node.js with socket.io):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const io = require('socket.io')(8000, {
  cors: { origin: "*" }
});

app.post('/sensor/update', (req, res) => {
  const sensorData = req.body;

  // Broadcast to all connected mobile apps
  io.emit('sensor_update', sensorData);

  res.json({ status: 'received' });
});

io.on('connection', (socket) => {
  console.log('Mobile app connected:', socket.id);
  socket.on('disconnect', () => {
    console.log('Mobile app disconnected:', socket.id);
  });
});

Example (Python with python-socketio):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

from socketio import AsyncServer
from aiohttp import web

sio = AsyncServer(async_mode='aiohttp', cors_allowed_origins='*')

@app.post('/sensor/update')
async def sensor_update(request):
    data = await request.json()

    # Broadcast to all connected apps
    await sio.emit('sensor_update', data)

    return web.json_response({'status': 'received'})

@sio.on('connect')
async def connect(sid, environ):
    print(f'Mobile app connected: {sid}')

@sio.on('disconnect')
async def disconnect(sid):
    print(f'Mobile app disconnected: {sid}')

================================================================================
SECURITY CHECKLIST FOR PRODUCTION
================================================================================

Before deploying to production:

â–¡ Use HTTPS/WSS (secure WebSocket) in production
â–¡ Implement JWT token authentication on Socket.IO connections
â–¡ Validate all incoming data on backend
â–¡ Rate limit sensor updates (prevent spam)
â–¡ Encrypt sensitive sensor data in transit
â–¡ Implement token refresh mechanism
â–¡ Log all connection/disconnection events
â–¡ Monitor for unusual activity patterns
â–¡ Implement user isolation (user only gets their own data)

================================================================================
PERFORMANCE OPTIMIZATION
================================================================================

For production with many users:

1. Use message compression
2. Implement data throttling (max 1 update per second)
3. Cache last known values to avoid redundant updates
4. Use binary protocol instead of JSON (lower overhead)
5. Implement pagination for historical data
6. Use Redis for pub/sub if scaling to 1000+ users

Example throttling (backend):
const throttle = require('lodash.throttle');
const broadcastSensorData = throttle((data) => {
  io.emit('sensor_update', data);
}, 1000); // Emit at most once per second

================================================================================
DEBUGGING TIPS
================================================================================

Enable Socket.IO debug logs (backend):

Node.js:
const io = require('socket.io')(8000, {
  cors: { origin: "*" },
  debug: true  // Enable debug output
});

Enable app logging (Flutter):

The app uses dart:developer.log() - view with:
flutter logs

Filter for Socket events:
flutter logs --grep="Socket\|socket"

Monitor network traffic (if needed):
- Use Wireshark to capture WebSocket frames
- Check if ws:// connection is established
- Verify 'sensor_update' messages are being sent

================================================================================
DEPLOYMENT CHECKLIST
================================================================================

Before deploying to production:

â˜ Update ApiConfig.baseUrl to production server IP
â˜ Test Socket.IO connection on production network
â˜ Verify firewall allows WebSocket connections
â˜ Set up SSL/TLS certificates for WSS
â˜ Test fallback HTTP polling works
â˜ Monitor logs for connection errors
â˜ Set up alerts for Socket.IO disconnections
â˜ Document the backend Socket.IO setup
â˜ Create runbook for debugging Socket issues
â˜ Test on real 4G/WiFi networks (not just LAN)

================================================================================
ROLLBACK PROCEDURE
================================================================================

If Socket.IO causes issues in production:

1. App automatically falls back to HTTP polling
2. No red error messages shown to users
3. Errors logged to console only
4. Data still updates (slower, every 10 seconds)

To completely disable Socket.IO:
- Remove Provider setup from main.dart
- Remove Socket.IO imports
- App will use HTTP polling exclusively

The code is backward compatible - removing Socket.IO won't break anything.

================================================================================
FEATURE ROADMAP
================================================================================

Phase 1 (CURRENT): âœ… Basic Socket.IO Integration
  - Real-time sensor updates
  - HTTP fallback mechanism
  - Connection status tracking

Phase 2 (PLANNED): Push Notifications
  - Alert notifications for critical values
  - Background Socket.IO listening
  - Local SQLite caching

Phase 3 (PLANNED): Data Sync
  - Store offline updates locally
  - Sync when coming back online
  - Conflict resolution

Phase 4 (PLANNED): Multi-device Support
  - Sync across multiple user devices
  - Cross-device notifications
  - Unified data view

================================================================================
SUPPORT & DOCUMENTATION
================================================================================

For detailed technical documentation, see:
ğŸ“„ SOCKET_IO_INTEGRATION.txt (in project root)

For quick reference:
ğŸ“„ SOCKET_IO_QUICK_START.txt (this file)

For code examples:
ğŸ“ lib/core/widgets/socket_widgets.dart
ğŸ“ lib/presentation/screens/home/home_screen.dart
ğŸ“ lib/presentation/screens/analytics/analytics_screen.dart

Questions? Check the logs:
flutter logs

Or review Socket.IO documentation:
https://socket.io/docs/v4/
https://pub.dev/packages/socket_io_client

================================================================================
END OF QUICK START GUIDE
================================================================================

